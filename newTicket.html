<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<title>New Ticket</title>
</head>
<body>
<h1>New Ticket</h1>
<a href="/html/pages/ticketHistory.html">All Tickets</a>
<br /><br />
<form id="new-ticket">
  Please fill in the form below to open a new ticket.<br /><br />
  <label for="name">Full Name:</label><input type="text" id="name"></input><br />
  <label for="email">Email:</label><input type="text" id="email"></input><br />
  <label for="phone">Phone:</label><input type="text" id="phone"></input><br />
  <label for="help-topic">Help Topic</label><select id="help-topic">
    <option value="none">None</option>
  </select><br />
  <label for="subject">Subject:</label><input type="text" id="subject"></input><br />
  <label for="comment">Comment:</label><textarea rows="6" cols="60" id="comment"></textarea><br />
  <label for="attachment">Attachment:</label><input type="file" id="attachment"></input><br />
  <br />
  <input type="button" id="submit-ticket" value="Submit Ticket"></input>
  <input type="button" id="reset-ticket" value="Reset"></input>
  <input type="button" id="cancel-ticket" value="Cancel"></input>
</form>
<script type="text/javascript" src="http://yui.yahooapis.com/combo?3.0.0/build/yui/yui-debug.js&3.0.0/build/json/json-debug.js&3.0.0/build/oop/oop-debug.js&3.0.0/build/event-custom/event-custom-debug.js&3.0.0/build/datatype/datatype-debug.js&3.0.0/build/dom/dom-debug.js&3.0.0/build/event/event-base-debug.js&3.0.0/build/pluginhost/pluginhost-debug.js&3.0.0/build/node/node-debug.js&3.0.0/build/event/event-delegate-debug.js&3.0.0/build/queue-promote/queue-promote-debug.js&3.0.0/build/io/io-debug.js&3.0.0/build/cookie/cookie-debug.js&3.0.0/build/dump/dump-debug.js"></script>
<script type="text/javascript" src="wut.js"></script>
<script type="text/javascript">
var Y = YUI().use("node", "json", "io", "datatype", "cookie");
var WUT = WUT({YUI:Y});
var TICKET = {name:"name", email:"email", phone:"phone", helpTopic:"helpTopic", subject:"subject", createDate:"createDate", status:"status"};
function getFormValues() {
  var ticket = {};
  ticket[TICKET.name] = Y.one("#name").get("value");
  ticket[TICKET.email] = Y.one("#email").get("value");
  ticket[TICKET.phone] = Y.one("#phone").get("value");
  ticket[TICKET.helpTopic] = Y.one("#help-topic").get("value");
  ticket[TICKET.subject] = Y.one("#subject").get("value");
  ticket[TICKET.createDate] = Y.DataType.Date.format(new Date(), {format:"%Y-%m-%d %T"});
  ticket[TICKET.status] = "open";

  return ticket;
};

var putTicket = function(e) {
  var ticket = getFormValues();
  WUT.put({resource: "virtual"}, {table:'ticket', data:ticket}, ticketSuccess);
};

var postTicket = function(e) {
  var ticket = getFormValues();
  WUT.post({resource: "virtual"}, {table:'ticket', id:ticketId, data:ticket}, ticketSuccess);
};

var ticketSuccess = function(id, o, a) {
  var lastId = o.result,
      COMMENT = {ticketId:"ticketId", createDate:"createDate", text:"text", name:"name"},
      comment = {};
  comment[COMMENT.ticketId] = lastId;
  comment[COMMENT.createDate] = Y.DataType.Date.format(new Date(), {format:"%Y-%m-%d %T"});
  comment[COMMENT.text] = Y.one("#comment").get("value");
  comment[COMMENT.name] = WUT.currentUser().username;

  WUT.put({resource: "virtual"}, {table:'comment', data:comment}, function(id, o, a) {
    if(a.args.lastId) {
      document.location = "/html/pages/viewTicket.html?ticket=" + a.args.lastId;
    }
  }, {lastId: lastId});
};

var ticketId = WUT.URL({source: document.location}).getQueryParams()["ticket"];
if(ticketId) {
  // TODO: lock form while loading
  WUT.get({resource: "virtual"}, {table:'ticket', id:ticketId}, function(id, o) {
    var ticketData = o.result[0];
    Y.one("#name").set("value", ticketData[TICKET.name]);
    Y.one("#email").set("value", ticketData[TICKET.email]);
    Y.one("#phone").set("value", ticketData[TICKET.phone]);
    Y.one("#help-topic").set("value", ticketData[TICKET.helpTopic]);
    Y.one("#subject").set("value", ticketData[TICKET.subject]);
  });
  Y.on("click", postTicket, "#submit-ticket", this);
} else {
  Y.on("click", putTicket, "#submit-ticket", this);
}

</script>
</body>
</html>
